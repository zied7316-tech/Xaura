# Caddyfile for Railway Deployment
# This file configures Caddy reverse proxy for api.xaura.pro

api.xaura.pro {
    # Enable automatic HTTPS
    tls {
        protocols tls1.2 tls1.3
    }

    # Reverse proxy to backend service
    reverse_proxy localhost:5000 {
        # Forward original host and protocol
        header_up Host {host}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Real-IP {remote}
        
        # Don't strip headers during reverse_proxy
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Credentials
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
    }

    # CORS Headers - Set by Caddy (fallback if backend doesn't set them)
    # Note: Caddy will set these, but backend should handle CORS primarily
    # These are fallback headers in case backend CORS fails
    
    # Handle preflight OPTIONS requests
    @options {
        method OPTIONS
    }
    handle @options {
        header Access-Control-Allow-Origin "https://www.xaura.pro"
        header Access-Control-Allow-Credentials "true"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
        header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With, Accept, Cache-Control, Pragma"
        header Access-Control-Max-Age "86400"
        respond 200
    }

    # Set CORS headers for all responses (as fallback)
    header {
        # Allow credentials
        Access-Control-Allow-Credentials "true"
        
        # Allow methods
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
        
        # Allow headers
        Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With, Accept, Cache-Control, Pragma"
        
        # Max age for preflight
        Access-Control-Max-Age "86400"
        
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
    }

    # Logging
    log {
        output stdout
        format console
    }
}

